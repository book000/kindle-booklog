# CLAUDE.md

## 目的

Claude Code の作業方針とプロジェクト固有ルールを示す。

## 判断記録のルール

判断は必ずレビュー可能な形で記録すること:

1. 判断内容の要約
2. 検討した代替案
3. 採用しなかった案とその理由
4. 前提条件・仮定・不確実性
5. 他エージェントによるレビュー可否

前提・仮定・不確実性を明示し、仮定を事実のように扱わない。

## プロジェクト概要

- 目的: Amazon.co.jp で購入した Kindle 作品を取得して、ブクログに登録する
- 主な機能:
  - Amazon.co.jp にログインして ASIN コードを取得
  - OTP による 2 段階認証に対応
  - ブクログへの個別登録（一括登録を行わない）
  - Twitter などへの自動投稿が可能

## 重要ルール

- 会話言語: 日本語
- コミット規約: Conventional Commits に従う
  - 形式: `<type>(<scope>): <description>`
  - `<description>` は日本語で記載
  - 例: `feat: OTP 認証機能を追加`
- コメント言語: 日本語
- エラーメッセージ言語: 英語
- 日本語と英数字の間には半角スペースを挿入

## 環境のルール

- ブランチ命名: Conventional Branch に従う
  - 形式: `<type>/<description>`
  - `<type>` は短縮形（feat, fix）を使用
  - 例: `feat/add-otp-auth`
- GitHub リポジトリ調査: テンポラリディレクトリに `git clone` して検索
- Renovate PR の扱い: 既存の Renovate PR には追加コミットや更新を行わない

## コード改修時のルール

- 既存のエラーメッセージで先頭に絵文字がある場合、全体で統一する
- TypeScript の `skipLibCheck` での回避は禁止
- 関数・インターフェースには docstring（JSDoc など）を日本語で記載・更新する

## 相談ルール

### Codex CLI の使用

以下の場合に Codex CLI を使用:

- 実装コードに対するソースコードレビュー
- 関数設計、モジュール内部の実装方針などの局所的な技術判断
- アーキテクチャ、モジュール間契約、パフォーマンス／セキュリティといった全体影響の判断
- 実装の正当性確認、機械的ミスの検出、既存コードとの整合性確認

### Gemini CLI の使用

以下の場合に Gemini CLI を使用:

- SaaS 仕様、言語・ランタイムのバージョン差、料金・制限・クォータといった、最新の適切な情報が必要な外部依存の判断
- 外部一次情報の確認、最新仕様の調査、外部前提条件の検証

### 指摘への対応

他エージェントが指摘・異議を提示した場合、Claude Code は必ず以下のいずれかを行う（黙殺・無言での不採用は禁止）:

- 指摘を受け入れ、判断を修正する
- 指摘を退け、その理由を明示する

## 開発コマンド

```bash
# 依存関係のインストール
pnpm install

# 開発（ウォッチモード）
pnpm dev

# 実行
pnpm start

# ビルド
pnpm compile

# ビルド（テスト用、noEmit）
pnpm compile:test

# クリーンアップ
pnpm clean

# Lint チェック
pnpm lint

# Lint 自動修正
pnpm fix

# TypeScript 型チェック
pnpm lint:tsc
```

## アーキテクチャと主要ファイル

### アーキテクチャサマリー

- `src/main.ts`: エントリーポイント
- `src/amazon.ts`: Amazon.co.jp へのログインと ASIN コード取得
- `src/booklog.ts`: Booklog へのログイン処理
- `src/booklog-update-book.ts`: Booklog への本の登録処理
- `src/proxy-auth.ts`: プロキシ認証処理
- `src/models/`: データモデル定義

### 主要ディレクトリ

- `src/`: TypeScript ソースコード
- `src/models/`: データモデル定義
- `.devcontainer/`: Dev Container 設定
- `.github/workflows/`: GitHub Actions ワークフロー

## 実装パターン

### 推奨パターン

- Puppeteer を使用したブラウザ自動操作
- Cookie ファイルによるセッション保持
- CSV パースによる既存データの確認
- 環境変数による設定管理

### 非推奨パターン

- 一括登録（Twitter などへの自動投稿ができなくなるため）
- ハードコードされた認証情報
- Cookie を無視した毎回のログイン処理

## テスト

### テスト方針

- 現時点ではテストフレームワークが導入されていない
- 新しいテストを追加する場合は、適切なテストフレームワーク（Jest など）の導入を検討する

### 追加テスト条件

- 重要な機能追加時はテストコードの追加を推奨
- E2E テストは実際の Amazon / Booklog へのアクセスが必要なため、モックを検討する

## ドキュメント更新ルール

### 更新対象

以下のドキュメントを適宜更新すること:

- `README.md`: プロジェクトの概要、使用方法、機能追加時の更新
- `CLAUDE.md`: Claude Code 向けの作業方針、アーキテクチャ変更時の更新
- `AGENTS.md`: AI エージェント向けの基本方針
- `GEMINI.md`: Gemini CLI 向けのコンテキスト

### 更新タイミング

- 機能追加・変更時: README.md を更新
- アーキテクチャ変更時: CLAUDE.md のアーキテクチャセクションを更新
- 開発コマンド追加・変更時: すべてのプロンプトファイルを更新

## 作業チェックリスト

### 新規改修時

1. プロジェクトを理解する
2. 作業ブランチが適切であることを確認する（既に PR を提出してクローズされたブランチでないこと）
3. 最新のリモートブランチに基づいた新規ブランチであることを確認する
4. PR がクローズされ、不要となったブランチは削除されていることを確認する
5. 指定されたパッケージマネージャー（pnpm）で依存関係をインストールする

### コミット・プッシュ前

1. Conventional Commits に従っていることを確認する
2. センシティブな情報（API キー、Cookie、認証情報など）が含まれていないことを確認する
3. Lint / Format エラーがないことを確認する（`pnpm lint`）
4. 動作確認を行い、期待通り動作することを確認する

### PR 作成前

1. PR 作成の依頼があることを確認する
2. センシティブな情報が含まれていないことを確認する
3. コンフリクトの恐れがないことを確認する

### PR 作成後

1. コンフリクトがないことを確認する
2. PR 本文が最新状態のみを網羅していることを確認する（更新履歴ではなく最終的な変更内容を記載）
3. `gh pr checks <PR ID> --watch` で GitHub Actions CI を確認する
4. Copilot レビューに対応し、コメントに返信する
5. Codex のコードレビューを実施し、指摘対応を行う
6. PR 本文の崩れがないことを確認する

## リポジトリ固有

- Docker / Docker Compose での動作を前提とする
- Amazon と Booklog のログインには Puppeteer を使用する
- Cookie ファイルによるセッション保持を実装している
- エクスポートされた CSV ファイルから既存の蔵書を確認する
- 登録履歴は JSON ファイルで管理する
- OTP による 2 段階認証に対応している
